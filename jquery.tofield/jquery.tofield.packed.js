;(function($){$.fn.toField=function(d){var e=[];if(d.searchKeys){$.each($.fn.toField.defaults.searchKeys,function(i,b){var c=false;b=m(b);$.each(d.searchKeys,function(i,a){a=m(a);if(a.property==b.property){c=true}});if(!c){e.push(b)}});e=e.concat($.map(d.searchKeys,function(a){return m(a)}))}else{e=$.map($.fn.toField.defaults.searchKeys,function(a){return m(a)})}d.searchKeys=e;var f=$.extend(true,{},$.fn.toField.defaults,d);return this.each(function(){var o=$.meta?$.extend({},f,$(this).data()):f;var a=q(s,[$(this),o])})};var m=function(a){return(typeof a=='string')?{property:a}:a};$.fn.toField.search=function(b){var c=[];var d=this.options.maxSuggestions;for(var i=0;i<this.options.searchKeys.length&&d>0;i++){key=this.options.searchKeys[i].property;if(this.options.searchKeys[i].search){var e=this.options.searchKeys[i].search(this.contacts,key,b,d)}else{var e=this.searchPrefixBy(key,b,d)}if(e){e=$.grep(e,function(a){for(var k=0;k<c.length;k++){if(c[k].isEqualToContact(a)){return false}}return true});d-=e.length;c=c.concat(e)}}return c};$.fn.toField.getResultItemMarkup=function(a){return'			<li class="search-result">				'+(!a.isMirror()?'<div class="contact-name">'+a.name+'</div>':'')+'				<div class="contact-identifier">&lt;'+a.identifier+'&gt;</div>			</li>'};$.fn.toField.getContactTokenMarkup=function(a){var b=a.getCustomClass();return'			<a href="javascript:void(0)" title="'+a.identifier+'" class="contact-token'+(b.length?' '+b:'')+'">				'+(a.name.length?a.name.replace(' ','&nbsp;'):a.identifier)+'			</a>'};$.fn.toField.setFormInput=function(b,c){c.val($.map(b,function(a){return a.identifier}).join(','))};$.fn.toField.truncateTokenToFit=function(a,b){var c=0;var d=$.trim(a.html());while(a.outerWidth(true)>b&&c++<100){a.html(d.substr(0,d.length-2)+'&hellip;');d=a.html()}};$.fn.toField.defaults={contacts:[],maxTokenRows:4,maxSuggestions:10,maxSuggestionRows:5,acceptAdHoc:true,idleDelay:100,scrollbarSize:18,searchKeys:['name','identifier'],search:$.fn.toField.search,setFormInput:$.fn.toField.setFormInput,getResultItemMarkup:$.fn.toField.getResultItemMarkup,getContactTokenMarkup:$.fn.toField.getContactTokenMarkup,truncateTokenToFit:$.fn.toField.truncateTokenToFit};var p={observers:{},addObserver:function(a,f){if(!this.observers[a]){this.observers[a]=[]}this.observers[a].push(f);return f},removeObserver:function(a,f){if(this.observers[a]){var b=this.observers[a];for(var i=0;i<b.length;i++){if(b[i]==f){break}}this.observers[a].splice(i,1)}},notifyObservers:function(b,c,d){if(b in this.observers){var e=this.observers[b];for(var i=0;i<e.length;i++){if(d){e[i].apply(e[i],[c])}else{setTimeout((function(a){return(function(){e[a].apply(e[a],[c])})})(i),1)}}}}};if(!Function.prototype._cfBind){Function.prototype._cfBind=function(a){var f=this;return(function(){return f.apply(a,arguments)})}}var q=function(a,b){function F(){};$.extend(true,F.prototype,a.prototype);return a.apply(new F(),b)};var s=function(a,b){this.options=b;this.jqFormInput=a;this.sortedContacts={};for(var i=0;i<this.options.searchKeys.length;i++){if(!this.options.searchKeys[i].search){this.sortedContacts[this.options.searchKeys[i].property]=[]}}this.search=b.search._cfBind(this);this.getResultItemMarkup=b.getResultItemMarkup._cfBind(this);this.getContactTokenMarkup=b.getContactTokenMarkup._cfBind(this);this.setFormInput=b.setFormInput._cfBind(this);if(typeof b.contacts=='function'){this.setContacts(b.contacts(),true)}else{this.setContacts(b.contacts,true)}this.options.maxSuggestionRows=Math.max(2,this.options.maxSuggestionRows);this.options.maxTokenRows=Math.max(2,this.options.maxTokenRows);this._mouseOverSearchResultsList=false;this._searchResultsShown=false;var w=a.innerWidth();var h=a.innerHeight();this.jqContainer=$('<div class="to-field"></div>').width(w).height(h);a.hide().before(this.jqContainer);this.insertInlineInput(false);this.jqContainer.mousedown(this.handleMouseDown._cfBind(this));this.addObserver('searchTextChanged',this.handleSearchTextChanged._cfBind(this));this.addObserver('searchCompleted',this.handleSearchCompleted._cfBind(this));this.addObserver('sortingCompleted',this.handleSortingCompleted._cfBind(this));this.calculateSearchParams();return this};$.extend(true,s.prototype,p,{contacts:[],searchResults:[],selectedTokens:[],searchHits:{},jqContainer:null,jqFormInput:null,jqInlineInput:null,jqInlineInputContainer:null,volatileContacts:false,jqHighlightedResult:null,jqResultsList:null,mirrorContact:null,searchText:'',keydownTimer:-1,currentSortKey:null,options:{},getFormName:function(){return this.jqFormInput.attr('name')},getFormInput:function(){return this.jqFormInput},handleMouseDown:function(a){if(a.target==this.jqContainer.get(0)||a.target==this.jqInlineInputContainer.get(0)){if(!this.probablyHasScrollbars()||!this.pointOverScrollbars(a.pageX,a.pageY)){this.insertInlineInput()}}},probablyHasScrollbars:function(){var b=false;$.each(['overflow','overflow-x','overflow-y'],(function(i,a){if(this.jqContainer.css(a)=='auto')b=true})._cfBind(this));return b},pointOverScrollbars:function(a,b){var c=this.jqContainer.offset();var w=this.jqContainer.outerWidth();var h=this.jqContainer.outerHeight();var r=(a>c.left+w-this.options.scrollbarSize&&a<c.left+w)||(b>c.top+h-this.options.scrollbarSize&&b<c.top+h);return r},createResultListItem:function(b){var c=$(this.getResultItemMarkup(b));if(b.customClass.length){c.addClass(b.customClass)}var d=this;c.contact=b;c.eventHandlers={mouseenter:function(a){d.highlightResult(c)},mouseleave:function(a){setTimeout(function(){if(d.getHighlightedResult()==c){c.removeClass('highlighted');d.highlightedResult=null}},100)},click:function(a){c.contact.select()}};for(var e in c.eventHandlers){c[e](c.eventHandlers[e])}return c},insertInlineInput:function(a){var i=this.getInlineInputContainer();i.width(this.jqContainer.innerWidth()-this.options.scrollbarSize);this.jqContainer.append(i);setTimeout((function(){this.jqInlineInput.focus()})._cfBind(this),10)},getInlineInputContainer:function(){if(this.jqInlineInputContainer){return this.jqInlineInputContainer}this.jqInlineInputContainer=$('<div class="inline-input-container"></div>');this.jqInlineInput=$('<input type="text" class="inline-input" />');this.jqInlineInput.keydown((function(a){switch(a.keyCode){case 38:this.highlightPrevResult();return false;case 40:this.highlightNextResult();return false;case 27:this.hideSearchResults();return false;case 13:case 188:this.selectHighlightedResult();return false}return true})._cfBind(this));this.jqInlineInput.keyup((function(a){var b=this.jqInlineInput.val();if(this.searchText!=b){this.setSearchText(b)}})._cfBind(this));this.jqInlineInput.blur((function(a){setTimeout((function(){if(!this._mouseOverSearchResultsList){this.hideSearchResults()}})._cfBind(this),1)})._cfBind(this));this.jqInlineInput.focus((function(){if(this.searchText.length){this.showSearchResults()}})._cfBind(this));this.jqInlineInputContainer.append(this.jqInlineInput);return this.jqInlineInputContainer},getSearchResultsList:function(){if(this.jqResultsList){return this.jqResultsList}this.jqResultsList=$('<ul class="search-results"></ul>');$('body').append(this.jqResultsList);this.jqResultsList.mouseenter((function(a){this._mouseOverSearchResultsList=true})._cfBind(this));this.jqResultsList.mouseleave((function(a){this._mouseOverSearchResultsList=false})._cfBind(this));return this.jqResultsList},createMirrorContact:function(){var c=q(u,[{name:'',identifier:''},this]);var a=this;c.addObserver('selectionStateChanged',a.handleContactSelectionStateChanged._cfBind(a));return c},getMirrorContact:function(){if(this.mirrorContact){return this.mirrorContact}this.mirrorContact=this.createMirrorContact();return this.mirrorContact},selectHighlightedResult:function(){if(this.jqHighlightedResult){var i=this.getHighlightedResultIndex();this.searchResults[i].select()}setTimeout((function(){this.insertInlineInput()})._cfBind(this),10)},highlightResult:function(a,b){if(!this._searchResultsShown){return}var c=this.getSearchResultsList();if(typeof a=='number'){a=$(c.children('li')[a])}c.children('li').removeClass('highlighted');this.jqHighlightedResult=a;if(this.jqHighlightedResult){this.jqHighlightedResult.addClass('highlighted');if(b==undefined||b=='scroll'){var d=this.jqHighlightedResult.position().top;var e=this.jqHighlightedResult.outerHeight();var f=c.scrollTop();var g=d+f;var h=c.innerHeight();if(d<0){c.scrollTop(g)}if(d+e>h){c.scrollTop(g+e-h)}}}},getHighlightedResult:function(){return this.jqHighlightedResult},getHighlightedResultIndex:function(){if(!this.jqHighlightedResult){return-1}var i=-1;var b=this.getSearchResultsList();b.children('li').each(function(a){if($(this).hasClass('highlighted')){i=a;return false}});return i},showSearchResults:function(){var a=this.getSearchResultsList();a.children('li').each(function(){if(this.parentNode){this.parentNode.removeChild(this)}});if(a.css('display')=='none'){a.height(1).css({overflow:'hidden'}).show()}var h=0;for(var i=0;i<this.searchResults.length;i++){var b=this.searchResults[i].getResultListItem();a.append(b);h+=b.outerHeight();if(i<this.options.maxSuggestionRows){a.height(h);a.css('overflow','hidden')}else if(i==this.options.maxSuggestionRows){a.css('overflow','auto')}}a.width(this.jqContainer.outerWidth());var c=this.jqContainer.offset();a.css({top:(c.top+this.jqContainer.outerHeight())+'px',left:(c.left)+'px'});this._searchResultsShown=true},hideSearchResults:function(){this.getSearchResultsList().fadeOut('fast');this._searchResultsShown=false},handleSearchTextChanged:function(a){if(a.length){this.dispatchSearch(a)}else{if(this.volatileContacts){this.pruneContacts()}this.hideSearchResults()}},highlightPrevResult:function(){if(!this.jqHighlightedResult){return}var a=this.getHighlightedResultIndex();if(a==-1){this.highlightResult(this.searchResults.length-1)}else if(a>0){this.highlightResult(a-1)}},highlightNextResult:function(){if(!this.jqHighlightedResult){return}var a=this.getHighlightedResultIndex();if(a==-1){this.highlightResult(0)}else{if(a>=0&&a<this.searchResults.length-1){this.highlightResult(a+1)}}},setSearchText:function(a){if(this.jqInlineInput.val()!=a){this.jqInlineInput.val(a)}this.searchText=a;this.notifyObservers('searchTextChanged',a,true)},getSearchText:function(){return this.searchText},sortKeyedContacts:function(){var d={};$.each(this.sortedContacts,function(a,b){d[a]=false});this.notifyObservers('sortingStarted');var e=this;for(var f in this.sortedContacts){setTimeout((function(c){return function(){e.sortedContacts[c]=e.contacts.slice(0);e.currentSortKey=c;e.sortedContacts[c].sort();d[c]=true;var b=true;$.each(d,function(k,a){if(!a)b=false});if(b){e.notifyObservers('sortingCompleted')}}})(f),10)}this.currentSortKey=null},calculateSearchParams:function(){var c=0;$.each(this.options.searchKeys,(function(i,a){c+=a.hits||0})._cfBind(this));$.each(this.options.searchKeys,(function(i,a){var b=a.hits?a.hits:0;this.searchHits[a.property]=Math.floor((b*this.options.maxSuggestions)/c)})._cfBind(this))},dispatchSearch:function(b){var f=(function(){var a=this.search(b,this.contacts);if(a!==undefined){this.notifyObservers('searchCompleted',a)}this.keydownTimer=-1})._cfBind(this);if(this.keydownTimer>0){clearTimeout(this.keydownTimer)}this.keydownTimer=setTimeout(f,this.options.idleDelay)},pruneContacts:function(){var n=this.contacts.length;this.contacts=$.grep(this.contacts,function(a){return a.isSelected()})},setContacts:function(b,c){if(!c&&this.volatileContacts){this.volatileContacts=false}this.pruneContacts();var d=this;$.each(b,function(i,a){if(!a.identifier){throw'Contact '+(a.name?a.name:'')+' does not have an identifier.';}if(!a._isADuck){contactObj=q(t,[a,d]);contactObj.addObserver('selectionStateChanged',d.handleContactSelectionStateChanged._cfBind(d))}else{contactObj=a}if(!contactObj.isSelected()){d.contacts.push(contactObj)}});if(!this.volatileContacts){this.sort()}},sort:function(){this.sortKeyedContacts()},searchPrefixBy:function(a,b,c){c=(c&&c>0)?c:0;if(this.sortedContacts[a]){var d=this.getRangeWithPrefix(b,a,this.sortedContacts[a],c);if(d.found){return this.sortedContacts[a].slice(d.start,d.end+1)}}return null},getRangeWithPrefix:function(a,b,c,d){d=(d&&d>0)?d:0;var e=0;var f=c.length-1;a=a.toLowerCase();var g=lastFound=middle=-1;for(var h=0;h<a.length;h++){g=this._binaryPrefixSearch(e,f,h,a,b,c);if(g!=-1){e=f=g;while((e-1>=0)&&c[e-1][b].toLowerCase().indexOf(a.substr(0,h+1))==0)e--;while((f+1<c.length)&&c[f+1][b].toLowerCase().indexOf(a.substr(0,h+1))==0)f++;lastFound=g}else{break}middle=g}if(g>=0){return{found:true,start:e,end:(d>0?Math.min(e+d-1,f):f)}}return{found:false,start:e,end:f}},_binaryPrefixSeachCmp:function(a,b,c,d){var e=a[d].toLowerCase();b=b.toLowerCase();if(c>=e.length||c>=b.length){r=e.length>b.length?1:-1;return r}r=(e.charAt(c)<=b.charAt(c)?(e.charAt(c)<b.charAt(c)?-1:0):1);return r},_binaryPrefixSearch:function(a,b,d,e,f,g){if(b==a){if(this._binaryPrefixSeachCmp(g[b],e,d,f)==0){return b}return-1}while(b>a){var h=Math.floor((a+b)/2);if(b-a==1){if(this._binaryPrefixSeachCmp(g[b],e,d,f)==0){return b}if(this._binaryPrefixSeachCmp(g[a],e,d,f)==0){return a}}var c=this._binaryPrefixSeachCmp(g[h],e,d,f);if(c>0){if(b==h){return-1}b=h}else if(c<0){if(a==h){return-1}a=h}else{return h}}return-1},searchExactBy:function(a,b){if(!this.volatileContacts){if(this.sortedContacts[a]){return this.binarySearch(b,a,this.sortedContacts[a])}}for(var i=0;i<this.contacts.length;i++){if(this.contacts[i][a]==b){return this.contacts[i]}}return null},binarySearch:function(a,b,c){var d={left:-1,right:-1,middle:-1,result:null};var e=null;var f=false;d=this._statefulBSearch(a,b,c,d);if((d.left>=0&&(d.left==d.middle||d.right==d.middle))||d.result){if(d.result){f=d.result}}return f},_statefulBSearch:function(a,b,c,d,e){a=a.toLowerCase();d.left=(d.left>=0?d.left:0);d.right=(d.right>=0?d.right:c.length-1);d.middle=(d.middle>=0?d.middle:Math.floor(d.right/2));if(!e){e=c.length}var i=0;while(d.left<d.right&&i<e){if(c[d.middle][b].toLowerCase()==a){d.result=c[d.middle];return d}else if(a<c[d.middle][b].toLowerCase()){d.right=d.middle}else if(a>c[d.middle][b].toLowerCase()){d.left=d.middle}if((d.right-d.left==1)&&(c[d.right][b].toLowerCase()==a)){d.result=c[d.right];return d}d.middle=Math.floor((d.right+d.left)/2);i++}return d},mergeContacts:function(a){var b=null;var c=this.contacts.slice(0);for(var i=0;i<a.length;i++){b=this.searchExactBy('identifier',a[i].identifier);if(!b){c.push(a[i])}}this.setContacts(c,true)},handleExternalSearchResults:function(b,c){this.volatileContacts=true;this.mergeContacts(b);var d=$.map(b,function(a,i){return a.identifier});this.notifyObservers('searchCompleted',$.grep(this.contacts,function(a,i){return($.inArray(a.identifier,d)!=-1)}))},handleSearchCompleted:function(a){var b=this.getHighlightedResultIndex();var c=this.searchResults[b];this.searchResults=[];for(var i=0;i<a.length;i++){if(!a[i].isSelected()){this.searchResults.push(a[i])}}if(this.options.acceptAdHoc){this.searchResults.unshift(this.getMirrorContact())}else if(this.searchResults.length==0){var d=this.getMirrorContact();d.setSelectable(false);this.searchResults.push(d)}this.showSearchResults();if((a.length==0&&this.options.acceptAdHoc)||!c){this.highlightResult(0)}else if(a.length==1&&this.searchResults.length==2){this.highlightResult(1)}else if(c){var e=false;for(var i=0;i<this.searchResults.length;i++){if(this.searchResults[i].isEqualToContact(c)){this.highlightResult(i);e=true;break}}if(!e){if(b>this.searchResults.length-1){b=Math.max(0,this.searchResults.length-1)}this.highlightResult(b)}}},handleSortingCompleted:function(){if(this.options.ready){this.options.ready(this)}},handleContactSelectionStateChanged:function(b){if(b.state==true){if(b.contact==this.mirrorContact){this.contacts.push(this.mirrorContact);this.mirrorContact=null}var c=q(v,[b.contact,this]);c.addObserver('tokenRemoved',this.layoutContainer._cfBind(this));c.addObserver('tokenAdded',this.layoutContainer._cfBind(this));c.addBefore(this.jqInlineInputContainer);this.setSearchText('');this.hideSearchResults();this.jqHighlightedResult=null;this.jqInlineInput.focus()}var d=$.grep(this.contacts,function(a){return a.isSelected()});this.setFormInput(d,this.jqFormInput)},layoutContainer:function(){var c=this.jqContainer.innerHeight();var d=0;var e=0;var f=0;var g=this.jqInlineInputContainer.outerHeight(true);var d=g;var h=-1;var i=0;var j=this;this.jqContainer.children().each(function(){var a=$(this);var b=a.parent().innerWidth()-j.options.scrollbarSize;if(j.options.truncateTokenToFit&&a.outerWidth()>b){j.options.truncateTokenToFit(a,b)}if(a.position().top!=h){f++;if(a.hasClass('inline-input-container')){d+=g}else{d+=e;e=$(this).outerHeight(true)}h=$(this).position().top}});if(f>(this.options.maxTokenRows+1)){this.jqContainer.height((this.options.maxTokenRows*e)+g);this.jqContainer.css('overflow','auto');this.jqContainer.css('overflow-x','hidden');var k=this.jqInlineInput.position().left;var l=this.jqContainer.innerWidth()-(k+this.jqInlineInput.outerWidth());if(l<this.options.scrollbarSize){this.jqInlineInput.width(this.jqInlineInput.width()-this.options.scrollbarSize)}}else{this.jqContainer.height((e*(f-1))+g);this.jqContainer.css('overflow','hidden');this.jqContainer.scrollTop(0)}}});var t=function(a,b){this.toField=b;$.extend(this,a);var x=this;this.toString=this._toString;return this};$.extend(true,t.prototype,p,{toField:null,name:'',identifier:'',customClass:'',selected:false,jqListItem:null,_isADuck:true,setName:function(a){this.name=a;this.notifyObservers('nameChanged',a,true)},setIdentifier:function(a){this.identifier=a;this.notifyObservers('identifierChanged',a,true)},getCustomClass:function(){return this.customClass},select:function(){this.selected=true;this.notifyObservers('selectionStateChanged',{contact:this,state:true})},deselect:function(){this.selected=false;this.notifyObservers('selectionStateChanged',{contact:this,state:false})},isMirror:function(){return false},isSelected:function(){return this.selected},isEqualToContact:function(a){return(this.identifier==a.identifier)},getResultListItem:function(){if(!this.jqListItem){this.jqListItem=this.toField.createResultListItem(this)}return this.jqListItem},clearResultListItem:function(){this.jqListItem=null},_toString:function(){if(this.toField.currentSortKey){return this[this.toField.currentSortKey]}return this.name}});var u=function(a,b){this.superclass.prototype.constructor.apply(this,arguments);this.handleSearchTextChanged=this.handleSearchTextChanged._cfBind(this);b.addObserver('searchTextChanged',this.handleSearchTextChanged);this.handleSearchTextChanged(b.getSearchText());return this};$.extend(true,u.prototype,t.prototype,{superclass:t,selectable:true,select:function(){if(this.selectable){this.toField.removeObserver('searchTextChanged',this.handleSearchTextChanged);this.superclass.prototype.select.apply(this)}},isMirror:function(){return true},getResultListItem:function(){var a=this.superclass.prototype.getResultListItem.apply(this);if(!a.hasClass('mirror')){a.addClass('mirror')}return a},handleSearchTextChanged:function(a){if(this.selectable){this.setIdentifier(a);this.setName(a);this.getResultListItem().html($(this.toField.getResultItemMarkup(this)).html())}},setSelectable:function(a){this.selectable=a;if(!this.selectable){this.setIdentifier('No Match');this.setName('No Match');this.getResultListItem().html($(this.toField.getResultItemMarkup(this)).html())}}});var v=function(b,c){this.contact=b;this.toField=c;this.jqContainer=c.jqContainer;b.addObserver('selectionStateChanged',this.handleContactSelectionStateChanged._cfBind(this));this.jqToken=$(c.getContactTokenMarkup(b));if(b.getCustomClass().length){this.jqToken.addClass(b.getCustomClass())}var d=this;this.jqToken.hover(function(a){d.jqToken.addClass('token-hover')},function(a){d.jqToken.removeClass('token-hover');d.jqToken.removeClass('x-hover')});this.jqToken.mousemove(this.handleMouseMove._cfBind(this));this.jqToken.click(this.handleClick._cfBind(this));return this};$.extend(true,v.prototype,p,{jqToken:null,toField:null,jqContainer:null,handleContactSelectionStateChanged:function(a){if(a.state==false){this.remove()}},addBefore:function(a){a.before(this.jqToken);this.notifyObservers('tokenAdded',{token:this,container:a.parent()})},remove:function(){this.jqToken.remove();this.notifyObservers('tokenRemoved',{token:this,container:this.jqToken.parent()})},pointIsOverX:function(a,b){var c=parseInt(this.jqToken.css('padding-left'),10);var d=parseInt(this.jqToken.css('padding-right'),10);c=isNaN(c)?0:c;d=isNaN(d)?0:d;var e=this.jqToken.innerWidth()-d;var f=this.jqToken.offset().left;return(a-f>e)},handleMouseMove:function(a){if(this.pointIsOverX(a.pageX,a.pageY)){this.jqToken.addClass('x-hover')}else{this.jqToken.removeClass('x-hover')}return false},handleClick:function(a){if(this.pointIsOverX(a.pageX,a.pageY)){this.contact.deselect()}}});if(!Array.prototype.indexOf){Array.prototype.indexOf=function(a){var b=this.length;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0)c+=b;for(;c<b;c++){if(c in this&&this[c]===a)return c}return-1}}})(jQuery);
